<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bc.admin.dao.NotifyInfoDao">

	<!--回调信息 -->
	<resultMap type="com.bc.admin.model.entity.NotifyInfoEntity" id="notifyMap">
		<id property="id" column="id" />
		<result property="agtPhone" column="agt_phone" />
		<result property="chargeMoney" column="charge_money" />
		<result property="profit" column="profit" />
		<result property="reqStreamId" column="req_stream_id" />
		<result property="orderNo" column="order_no" />
		<result property="notifyUrl" column="notify_url" />
		<result property="applyTime" column="apply_time" />
		<result property="count" column="count" />
		<result property="flag" column="flag" />
		<result property="state" column="state" />
	</resultMap>

	<!-- 查询回调列表详情 -->
	<select id="queryNotifyList" parameterType="com.bc.admin.model.vo.NotifyInfoVO" resultType="com.bc.admin.model.entity.NotifyInfoEntity">
		select DISTINCT bon.id,bon.agt_phone agtPhone,bon.charge_money chargeMoney,bon.req_stream_id reqStreamId,
		bon.order_no orderNo,CONCAT(bbi.bank_account,'|',bbi.bank_name,'|',RIGHT(bon.charge_addr,4)) chargeAddr,
		bon.notify_url notifyUrl,bon.count,flag,bon.state,bon.pay_account_name payAccountName,bon.price,bon.profit,
		date_format(bon.apply_time,'%Y-%m-%d %T') applyTime
		from bc_order_nofity bon
		left join bc_bank_info bbi on bbi.card_no = bon.charge_addr
		where 1=1
		<if test="agtPhone !=null and agtPhone!=''">
			and bon.agt_phone = #{agtPhone}
		</if>
		<if test="null != startTime and  ''!= startTime">
			<![CDATA[and bon.apply_time  between #{startTime} and #{endTime} ]]>
		</if>
		<if test="reqStreamId !=null and reqStreamId !=''">
			and bon.req_stream_id =#{reqStreamId}
		</if>
		<if test="null != flag and flag != -1	">
			and bon.flag =#{flag}
		</if>
		<if test="null != orderNo and orderNo != ''	">
			and bon.order_no =#{orderNo}
		</if>
		<if test="null != chargeAddr and chargeAddr != ''	">
			and bon.charge_addr =#{chargeAddr}
		</if>
		<if test="null != flagIds and  flagIds.size() > 0">
			and flag in
			<foreach collection="flagIds" item="id" index="index"
					 open="(" close=")" separator=",">
				#{id}
			</foreach>
		</if>

		order by bon.apply_time desc
	</select>

	<select id="querySumAmount" parameterType="com.bc.admin.model.vo.NotifyInfoVO" resultType="java.util.HashMap">
		select count(1) sumCount,
		sum(bon.charge_money) sumAount,
		(sum(bon.charge_money) * ifnull(profit,0)) inProfitMoney,
		sum(bon.charge_money) - (sum(bon.charge_money) * ifnull(profit,0)) agtProfitMoney,
		bon.charge_addr accountNo,bbi.bank_name bankName,bon.profit,
		bbi.bank_account accountName
		from bc_order_nofity bon left join bc_bank_info bbi
		on bon.agt_phone = bbi.agt_phone and bbi.card_no = bon.charge_addr
		where bon.flag != 5
		<if test="null != startTime and  ''!= startTime">
			<![CDATA[and bon.apply_time  between #{startTime} and #{endTime} ]]>
		</if>
		<if test="null != agtPhone and '' != agtPhone">
			and bon.agt_phone = #{agtPhone}
		</if>
		group by bon.charge_addr
	</select>

	<select id="queryAgentSumAmount" parameterType="com.bc.admin.model.vo.NotifyInfoVO" resultType="java.util.HashMap">
		select count(1) sumCount,bon.profit,
		sum(bon.charge_money) sumAount,
		(sum(bon.charge_money) * ifnull(profit,0)) inProfitMoney,
		sum(bon.charge_money) - (sum(bon.charge_money) * ifnull(profit,0)) agtProfitMoney
		from bc_order_nofity bon
		where bon.flag != 5
		<if test="null != startTime and  ''!= startTime">
			<![CDATA[and bon.apply_time  between #{startTime} and #{endTime} ]]>
		</if>
		<if test="null != agtPhone and '' != agtPhone">
			and bon.agt_phone = #{agtPhone}
		</if>
	</select>

	<update id="updateNotifyInfo" parameterType="com.bc.admin.model.vo.NotifyInfoVO">
		update bc_order_nofity
		<set>
			<if test="null != flag and flag != -1">
				flag = #{flag},
			</if>
			<if test="chargeMoney != null and chargeMoney != '' ">
				charge_money = #{chargeMoney},
			</if>
		</set>
		where 1=1 and flag != 2
		<if test="null != id and '' != id">
			and id = #{id}
		</if>
		<if test="null != orderNo and '' != orderNo">
			and order_no = #{orderNo}
		</if>
	</update>

	<update id="updateOrderInfo" parameterType="com.bc.admin.model.vo.NotifyInfoVO">
		update bc_order_charge set exp2 = #{payAccountName} where order_no = #{orderNo}
	</update>
</mapper>