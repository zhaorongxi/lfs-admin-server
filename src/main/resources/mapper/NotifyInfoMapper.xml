<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bc.admin.dao.NotifyInfoDao">

	<!--回调信息 -->
	<resultMap type="com.bc.admin.model.entity.NotifyInfoEntity" id="notifyMap">
		<id property="id" column="id" />
		<result property="agtPhone" column="agt_phone" />
		<result property="chargeMoney" column="charge_money" />
		<result property="profit" column="profit" />
		<result property="reqStreamId" column="req_stream_id" />
		<result property="orderNo" column="order_no" />
		<result property="notifyUrl" column="notify_url" />
		<result property="applyTime" column="apply_time" />
		<result property="count" column="count" />
		<result property="flag" column="flag" />
		<result property="state" column="state" />
	</resultMap>

	<!-- 查询回调列表详情 -->
	<select id="queryNotifyList" parameterType="com.bc.admin.model.vo.NotifyInfoVO" resultType="com.bc.admin.model.entity.NotifyInfoEntity">
		select DISTINCT bon.id,bon.agt_phone agtPhone,bon.charge_money chargeMoney,bon.req_stream_id reqStreamId,
		bon.order_no orderNo,CONCAT(bbi.bank_account,'|',bbi.bank_name,'|',RIGHT(bon.charge_addr,4)) chargeAddr,
		bon.notify_url notifyUrl,bon.count,flag,bon.state,bon.pay_account_name payAccountName,bon.price,bon.profit,
		date_format(bon.apply_time,'%Y-%m-%d %T') applyTime
		from bc_order_nofity bon
		left join bc_bank_info bbi on bbi.card_no = bon.charge_addr
		where 1=1
		<if test="agtPhone !=null and agtPhone!=''">
			and bon.agt_phone = #{agtPhone}
		</if>
		<if test="null != startTime and  ''!= startTime">
			<![CDATA[and bon.apply_time  between #{startTime} and #{endTime} ]]>
		</if>
		<if test="null != flag and flag != -1	">
			and bon.flag =#{flag}
		</if>
		<if test="null != reqStreamId and '' != reqStreamId ">
			and bon.req_stream_id = #{reqStreamId}
		</if>
		<if test="null != orderNo and orderNo != ''	">
			and bon.order_no =#{orderNo}
		</if>
		<if test="null != chargeAddr and chargeAddr != ''	">
			and bon.charge_addr =#{chargeAddr}
		</if>
		<if test="null != flagIds and  flagIds.size() > 0">
			and flag in
			<foreach collection="flagIds" item="id" index="index"
					 open="(" close=")" separator=",">
				#{id}
			</foreach>
		</if>
		<if test="payAccountName !=null and payAccountName !='' and payAccountName == '-1'">
			and bon.pay_account_name  is not null
		</if>
		<if test="null != payAccountName and '' != payAccountName and payAccountName != '-1'">
			and bon.pay_account_name = #{payAccountName}
		</if>

		order by bon.apply_time desc
	</select>

	<select id="querySumAmount" parameterType="com.bc.admin.model.vo.NotifyInfoVO" resultType="java.util.HashMap">
		select count(1) sumCount,
		sum(bon.charge_money) sumAount,
		(sum(bon.charge_money) * ifnull(profit,0)) inProfitMoney,
		sum(bon.charge_money) - (sum(bon.charge_money) * ifnull(profit,0)) agtProfitMoney,
		bon.charge_addr accountNo,bbi.bank_name bankName,bon.profit,
		bbi.bank_account accountName
		from bc_order_nofity bon left join bc_bank_info bbi
		on bon.agt_phone = bbi.agt_phone and bbi.card_no = bon.charge_addr
		where bon.flag != 5
		<if test="null != startTime and  ''!= startTime">
			<![CDATA[and bon.apply_time  between #{startTime} and #{endTime} ]]>
		</if>
		<if test="null != agtPhone and '' != agtPhone">
			and bon.agt_phone = #{agtPhone}
		</if>
		group by bon.charge_addr
	</select>

	<select id="queryListAmount" parameterType="com.bc.admin.model.vo.NotifyInfoVO" resultType="java.util.HashMap">
		select count(1) sumCount,
		sum(bon.charge_money) sumAount,bon.agt_phone agtPhone,
		DATE_FORMAT(bon.apply_time,"%Y-%m-%d") applyTime
		from bc_order_nofity bon
		where bon.flag != 5
		<if test="null != startTime and  ''!= startTime">
			<![CDATA[and bon.apply_time  between #{startTime} and #{endTime} ]]>
		</if>
		<if test="null != isGroupByDay and 1 == isGroupByDay">
			group by bon.agt_phone
		</if>
		<if test="null != isGroupByDay and 2 == isGroupByDay">
			group by bon.agt_phone,DATE_FORMAT(bon.apply_time,"%Y-%m-%d")
		</if>

	</select>

	<select id="queryTotalAmount" parameterType="com.bc.admin.model.vo.NotifyInfoVO" resultType="java.util.HashMap">
		select bon.agt_phone agtPhone,
		count(case when bon.flag = 2 then bon.flag  end ) successSumCount,
		count(case when bon.pay_account_name is not null then bon.flag end) channelSumCount,
		count(1) sumCount,
		count(case when bon.flag = 5 and bon.pay_account_name is not null then bon.flag  end ) failSumCount,
		count(case when bon.flag = 5 and bon.pay_account_name is null then bon.flag end) noPaySumCount
		from bc_order_nofity bon
		where 1 = 1
		<if test="null != startTime and  ''!= startTime">
			<![CDATA[and bon.apply_time  between #{startTime} and #{endTime} ]]>
		</if>
		<if test="null != agtPhone and '' != agtPhone">
			and bon.agt_phone = #{agtPhone}
		</if>
		group by bon.agt_phone
	</select>

	<select id="queryTotalAmountByHours" parameterType="com.bc.admin.model.vo.NotifyInfoVO" resultType="java.util.HashMap">
		select count(1) sumCount,bon.agt_phone agtPhone,
		DATE_FORMAT(bon.apply_time,"%Y-%m-%d %H") applyTime
		from bc_order_nofity bon
		where 1=1
		<if test="null != startTime and  ''!= startTime">
			<![CDATA[and bon.apply_time  between #{startTime} and #{endTime} ]]>
		</if>
		<if test="null != agtPhone and '' != agtPhone">
			and bon.agt_phone = #{agtPhone}
		</if>
		group by bon.agt_phone,DATE_FORMAT(bon.apply_time,"%Y-%m-%d %H")
	</select>

	<select id="querySuccessAmount" parameterType="com.bc.admin.model.vo.NotifyInfoVO" resultType="java.util.HashMap">
		select
		sum(case when bon.flag = 2 then bon.charge_money  end ) successSumAmount,
		sum(case when to_days(bon.apply_time) = to_days(now()) and bon.flag =2 then (bon.charge_money * ifnull(profit,0)) end ) todaySumAmount
		from bc_order_nofity bon
	</select>

	<select id="querySystemAmount" parameterType="com.bc.admin.model.vo.NotifyInfoVO" resultType="java.util.HashMap">
		select
		(baw.credit + baw.freeze) sumUnCheckMoney,
		sum(bwa.cash_money) sumCashMoney
		from bc_agt_wallet baw
		left JOIN bc_wallet_approve bwa on baw.agt_phone = bwa.agt_phone and bwa.`status` = 2
		where baw.agt_phone = 'system'
	</select>

	<select id="queryBankAmount" parameterType="com.bc.admin.model.vo.NotifyInfoVO" resultType="java.util.HashMap">
		select bbi.bank_account bankAccount,bbi.bank_name bankName,
		RIGHT(bon.charge_addr,4) chargeAddr,count(1) totalCount
		from bc_order_nofity  bon
		left join bc_bank_info bbi on bon.charge_addr  = bbi.card_no and bbi.status = 0
		where  to_days(bon.apply_time) = to_days(now())
		group by bon.charge_addr order by totalCount desc
	</select>

	<select id="queryAgentSumAmount" parameterType="com.bc.admin.model.vo.NotifyInfoVO" resultType="java.util.HashMap">
		select count(1) sumCount,bon.profit,
		sum(bon.charge_money) sumAount,
		(sum(bon.charge_money) * ifnull(profit,0)) inProfitMoney,
		sum(bon.charge_money) - (sum(bon.charge_money) * ifnull(profit,0)) agtProfitMoney
		from bc_order_nofity bon
		where bon.flag != 5
		<if test="null != startTime and  ''!= startTime">
			<![CDATA[and bon.apply_time  between #{startTime} and #{endTime} ]]>
		</if>
		<if test="null != agtPhone and '' != agtPhone">
			and bon.agt_phone = #{agtPhone}
		</if>
	</select>

	<update id="updateNotifyInfo" parameterType="com.bc.admin.model.vo.NotifyInfoVO">
		update bc_order_nofity
		<set>
			<if test="null != flag and flag != -1">
				flag = #{flag},
			</if>
			<if test="chargeMoney != null and chargeMoney != '' ">
				charge_money = #{chargeMoney},
			</if>
		</set>
		where 1=1 and flag != 2
		<if test="null != id and '' != id">
			and id = #{id}
		</if>
		<if test="null != orderNo and '' != orderNo">
			and order_no = #{orderNo}
		</if>
	</update>

	<update id="updateOrderInfo" parameterType="com.bc.admin.model.vo.NotifyInfoVO">
		update bc_order_charge
		<set>
			<if test="null != payAccountName and '' != payAccountName">
				exp2 = #{payAccountName},
			</if>
			<if test="null != outMoney">
				out_money = #{outMoney},
			</if>
			<if test="null != chargeMoney">
				price = #{chargeMoney}
			</if>
		</set>
		where order_no = #{orderNo}
	</update>
</mapper>